---
# Workstation Playbook
# Runs on ASTER and YUGEN hosts only
#
# Usage:
#   ansible-playbook main.yml --ask-vault-pass
#   ansible-playbook main.yml --vault-password-file=~/.vault_pass
#
# Execution Flow:
#   1. user      - Create users, SSH keys, shell configs
#   2. os        - Locale, network, NTP, services
#   3. pipewire  - Audio stack
#   4. gpu       - Graphics drivers
#   5. xfce4     - Desktop environment, LightDM, bluetooth
#   6. gaming    - Steam, Lutris, gamemode
#   7. onedrive  - OneDrive client installation and setup
#   8. bootstrap - OneDrive sync (interactive), symlinks, XFCE config
#
# NOTE: The bootstrap role will pause for OneDrive authentication.
# Follow the on-screen instructions to authenticate with Microsoft.

- name: Configure workstation
  hosts: localhost
  connection: local
  become: true

  vars_files:
    - vault

  pre_tasks:
    - name: Read hostname from /etc/hostname
      ansible.builtin.slurp:
        src: /etc/hostname
      register: hostname_file

    - name: Set hostname fact
      ansible.builtin.set_fact:
        current_hostname: "{{ (hostname_file.content | b64decode).strip() | upper }}"
        current_hostname_raw: "{{ (hostname_file.content | b64decode).strip() }}"

    - name: Display detected hostname
      ansible.builtin.debug:
        msg: "Detected hostname: {{ current_hostname }}"

    - name: Verify hostname is ASTER or YUGEN
      ansible.builtin.assert:
        that:
          - current_hostname in ['ASTER', 'YUGEN']
        fail_msg: "This playbook only runs on ASTER or YUGEN. Current hostname: {{ current_hostname }}"
        success_msg: "Hostname verified: {{ current_hostname }}"

    - name: Set hostname variables for roles
      ansible.builtin.set_fact:
        cached_hostname: "{{ current_hostname }}"
        cached_hostname_raw: "{{ current_hostname_raw }}"
        hostname: "{{ current_hostname }}"
        cacheable: true

    - name: Set host-specific bootstrap variables for ASTER
      ansible.builtin.set_fact:
        bootstrap_xfce_monitors:
          - "eDP-1"
          - "DP-1-1"
      when: current_hostname == 'ASTER'

    - name: Set host-specific bootstrap variables for YUGEN
      ansible.builtin.set_fact:
        bootstrap_xfce_monitors:
          - "DP-1"
          - "DP-2"
          - "DP-3"
      when: current_hostname == 'YUGEN'

  roles:
    - role: tekne.devops.user
      tags: [user]

    - role: tekne.devops.os
      tags: [os]

    - role: tekne.devops.pipewire
      tags: [pipewire]

    - role: tekne.devops.gpu
      tags: [gpu]

    - role: tekne.devops.xfce4
      tags: [xfce4]

    - role: tekne.devops.gaming
      tags: [gaming]

    - role: tekne.devops.onedrive
      tags: [onedrive]

    - role: tekne.devops.bootstrap
      tags: [bootstrap]

    - role: tekne.devops.docker
      tags: [docker]

    - role: tekne.devops.libvirt
      tags: [libvirt]

    - role: tekne.devops.nftables
      tags: [nftables]

    - role: tekne.devops.haproxy
      tags: [haproxy]

    - role: tekne.devops.repotekne
      tags: [repotekne]

    - role: tekne.devops.gerbera
      tags: [gerbera]